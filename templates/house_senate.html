{% extends 'base.html' %}
{% block title %}The U.S. {{ house.title() }} | BigBoard Admin{% endblock %}
{% block extra_head %}
    <style type='text/css'>
        .gop {
            color:red;
        }
        .dem {
            color:blue;
        }
        .incumbent {
            text-transform:uppercase;
        }
        .clear {width:100%; clear:both;}
        tr.info td { }
        td.ap-call { text-align:center!important; }
        .modal { display:none; }
        .btn {text-transform:none;}
    </style>
{% endblock %}

{% block content %}

<div class="row">
    <div class="span12">
        <h1>BigBoard Admin: The U.S. {{ house.title() }}</h1>

        <table class="table table-striped table-bordered table-hover table-condensed">
        <tr class="info">
            <td><strong>State</strong></td>
            <td><strong>Candidates</strong></td>
            <td></td>
            <td><strong>Accept AP calls</strong></td>
        </tr>
        {% for grouper, list in candidates|groupby('race_slug') %}
        {% if loop.index % 20 == 0  %}
        <tr class="info">
            <td><strong>State</strong></td>
            <td><strong>Candidates</strong></td>
            <td></td>
            <td><strong>Accept AP calls</strong></td>
        </tr>
        {% endif %}
        <tr>
            <td>{% if house == "senate" %}
                {{ grouper.replace(' 0', '').upper() }}
            {% else %}
                {{ grouper.upper() }}
            {% endif %}</td>

            <td>{% for race in list %}
                {% if loop.first %}

                <span class="
                    {% if race.incumbent == '1' %}incumbent{% endif %}
                    {{ race.party.lower() }}
                    {% if race.accept_ap_call %}{% if race.ap_call != '' %}called{% endif %}{% endif %}
                ">
                    {{ race.first_name }} {{ race.last_name}}
                    {# include 'includes/race_winner_buttons.html' #}
                </span>
                {% endif %}
            {% endfor %}</td>
            <td>{% for race in list %}
                {% if loop.index == 2 %}

                <span class="
                    {% if race.incumbent == '1' %}incumbent{% endif %}
                    {{ race.party.lower() }}
                    {% if race.accept_ap_call %}{% if race.ap_call != '' %}called{% endif %}{% endif %}
                ">
                    {{ race.first_name }} {{ race.last_name}}
                    {# include 'includes/race_winner_buttons.html' #}
                </span>
                {% endif %}
            {% endfor %}</td>
            <td class="ap-call">{% for race in list %}{% if loop.first %}
            <a
                id="{{ race.race_slug.replace(' ', '').lower() }}"
                class="btn {% if race.accept_ap_call == '1' %}btn-success{% else %}btn-danger{% endif %} btn-mini"
                data-race-slug="{{ grouper.replace(' ', '') }}">
                    {% if race.accept_ap_call == "1" %}Accepting AP calls{% else %}Not accepting AP calls{% endif %}</a>
            {% endif %}{% endfor %}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
    <h3 id="myModalLabel"></h3>
  </div>
  <div class="modal-body">
    <p></p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
</div>
{% endblock %}

{% block extra_foot %}
    <script type="text/javascript">

        // A sort of generic function to read options and handle changing button state and POSTing to an URL.
        function buttonPOST(options){

            // Monkey with buttons.
            $(options.target).removeClass(options.button.pre_state);
            $(options.target).addClass(options.button.post_state);
            $(options.target).html(options.message);

            // POST some data.
            $.post('.', options.post_data, function(data){

                // Show a message.
                $('#myModalLabel').html(data.split('|')[0])
                $('#myModal .modal-body p').html(data.split('|')[1])
                $('#myModal').modal();
            });
        }

        // If someone clicks on the ap-call buttons ...
        $('.ap-call .btn').click(function(){

            // Identify the race.
            var race_slug = $(this).attr('id')

            // If we're already accepting ap calls, do the opposite.
            if ( $(this).hasClass('btn-success') ) {

                // Here's the options. Ain't javascript fun?
                buttonPOST({
                    post_data: {
                        race_slug: race_slug,
                        accept_ap_call: false
                    },
                    button: {
                        pre_state: 'btn-success',
                        post_state: 'btn-danger'
                    },
                    message: 'Not accepting AP calls',
                    target: this
                });

            // Otherwise, do the opposite.
            } else {
                buttonPOST({
                    post_data: {
                        race_slug: race_slug,
                        accept_ap_call: true
                    },
                    button: {
                        pre_state: 'btn-danger',
                        post_state: 'btn-success'
                    },
                    message: 'Accepting AP calls',
                    target: this
                });
            }
        });
    </script>
{% endblock %}